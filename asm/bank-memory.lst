ca65 V2.18 - Git b8ae5c2
Main file   : ram2.s
Current file: ram2.s

000000r 1               ; Test access to the memory card ($D000 and above).
000000r 1               ; This is an adaptation of Zellyn's a2audit tests made to be run headlessly:  https://github.com/zellyn/a2audit
000000r 1               ; If the tests succed, $3D contains the number of successful tests
000000r 1               ; If a test fails, the code lands on a BRK, $3D contains the number of passed tests,
000000r 1               ; and Y is the index of the comparison that failed (1-5)
000000r 1               ;
000000r 1               ; Cedric Beust, cedric@beust.com, 9/17/2020
000000r 1               ;
000000r 1               
000000r 1               D1 := $d17b
000000r 1               FE := $fe1f
000000r 1               checkdata := $3f
000000r 1               TEST_COUNT := $3d
000000r 1               
000000r 1               .macro verify address
000000r 1                   ldx address
000000r 1                   iny
000000r 1                   lda (checkdata),Y
000000r 1                   cmp address
000000r 1                   bne @fail
000000r 1               .endmacro
000000r 1               
000000r 1  20 rr rr         jsr @reset
000003r 1  A9 00            lda #0
000005r 1  85 3D            sta TEST_COUNT
000007r 1               
000007r 1               	;; Format:
000007r 1               	;; Sequence of test instructions, finishing with `jsr .test`.
000007r 1               	;; - quint: expected current $d17b and fe1f, then d17b in bank1, d17b in bank 2, and fe1f
000007r 1               	;; (All sequences start with lda $C080, just to reset things to a known state.)
000007r 1               	;; 0-byte to terminate tests.
000007r 1               
000007r 1  AD 88 C0     	lda $C088				; Read $C088 (read bank 1, no write)
00000Ar 1  20 rr rr     	jsr @test				;
00000Dr 1  11 33 11 22  	.byte $11, $33, $11, $22, $33
000011r 1  33           
000012r 1               
000012r 1  AD 80 C0     	lda $C080				; Read $C080 (read bank 2, no write)
000015r 1  20 rr rr     	jsr @test				;
000018r 1  22 33 11 22  	.byte $22, $33, $11, $22, $33		;
00001Cr 1  33           
00001Dr 1               
00001Dr 1  AD 81 C0     	lda $C081				; Read $C081 (ROM read, write disabled)
000020r 1  20 rr rr     	jsr @test				;
000023r 1  53 60 11 22  	.byte $53, $60, $11, $22, $33		;
000027r 1  33           
000028r 1               
000028r 1  AD 81 C0     	lda $C081				; Read $C081 (rom read, all else false)
00002Br 1  AD 89 C0     	lda $C089				; Read $C089 (ROM read, all else false)
00002Er 1  20 rr rr     	jsr @test				;
000031r 1  53 60 54 22  	.byte $53, $60, $54, $22, $61		;
000035r 1  61           
000036r 1               
000036r 1  AD 81 C0         lda $C081				; Read $C081, $C081 (read ROM, write RAM bank 2)
000039r 1  AD 81 C0     	lda $C081				;
00003Cr 1  20 rr rr     	jsr @test				;
00003Fr 1  53 60 11 54  	.byte $53, $60, $11, $54, $61		;
000043r 1  61           
000044r 1               
000044r 1  AD 81 C0     	lda $C081				; Read $C081, $C081, write $C081 (read ROM, write RAM bank bank 2)
000047r 1  AD 81 C0     	lda $C081				; See https://github.com/zellyn/a2audit/issues/3
00004Ar 1  8D 81 C0     	sta $C081				;
00004Dr 1  20 rr rr     	jsr @test				;
000050r 1  53 60 11 54  	.byte $53, $60, $11, $54, $61		;
000054r 1  61           
000055r 1               
000055r 1  AD 81 C0     	lda $C081				; Read $C081, $C081; write $C081, $C081
000058r 1  AD 81 C0     	lda $C081				; See https://github.com/zellyn/a2audit/issues/4
00005Br 1  8D 81 C0     	sta $C081				;
00005Er 1  8D 81 C0     	sta $C081				;
000061r 1  20 rr rr     	jsr @test				;
000064r 1  53 60 11 54  	.byte $53, $60, $11, $54, $61		;
000068r 1  61           
000069r 1               
000069r 1  AD 8B C0     	lda $C08B				; Read $C08B (read RAM bank 1, no write)
00006Cr 1  20 rr rr     	jsr @test				;
00006Fr 1  11 33 11 22  	.byte $11, $33, $11, $22, $33		;
000073r 1  33           
000074r 1               
000074r 1  AD 83 C0     	lda $C083				; Read $C083 (read RAM bank 2, no write)
000077r 1  20 rr rr     	jsr @test				;
00007Ar 1  22 33 11 22  	.byte $22, $33, $11, $22, $33		;
00007Er 1  33           
00007Fr 1               
00007Fr 1  AD 8B C0     	lda $C08B				; Read $C08B, $C08B (read/write RAM bank 1)
000082r 1  AD 8B C0     	lda $C08B				;
000085r 1  20 rr rr     	jsr @test				;
000088r 1  12 34 12 22  	.byte $12, $34, $12, $22, $34		;
00008Cr 1  34           
00008Dr 1               
00008Dr 1  AD 8F C0     	lda $C08F				; Read $C08F, $C087 (read/write RAM bank 2)
000090r 1  AD 87 C0     	lda $C087				;
000093r 1  20 rr rr     	jsr @test				;
000096r 1  23 34 11 23  	.byte $23, $34, $11, $23, $34		;
00009Ar 1  34           
00009Br 1               
00009Br 1  AD 87 C0     	lda $C087				; Read $C087, read $C08D (read ROM, write bank 1)
00009Er 1  AD 8D C0     	lda $C08D				;
0000A1r 1  20 rr rr     	jsr @test				;
0000A4r 1  53 60 54 22  	.byte $53, $60, $54, $22, $61		;
0000A8r 1  61           
0000A9r 1               
0000A9r 1  AD 8B C0     	lda $C08B				; Read $C08B, write $C08B, read $C08B (read RAM bank 1, no write)
0000ACr 1  8D 8B C0     	sta $C08B				; (this one is tricky: reset WRTCOUNT by writing halfway)
0000AFr 1  AD 8B C0     	lda $C08B				;
0000B2r 1  20 rr rr     	jsr @test				;
0000B5r 1  11 33 11 22  	.byte $11, $33, $11, $22, $33		;
0000B9r 1  33           
0000BAr 1               
0000BAr 1  8D 8B C0     	sta $C08B				; Write $C08B, write $C08B, read $C08B (read RAM bank 1, no write)
0000BDr 1  8D 8B C0     	sta $C08B				;
0000C0r 1  AD 8B C0     	lda $C08B				;
0000C3r 1  20 rr rr     	jsr @test				;
0000C6r 1  11 33 11 22  	.byte $11, $33, $11, $22, $33		;
0000CAr 1  33           
0000CBr 1               
0000CBr 1               ;	clc					    ; Read $C083, $C083 (read/write RAM bank 2)
0000CBr 1               ;	ldx #0					; Uses "6502 false read"
0000CBr 1               ;	inc $C083,x				; Actually reads $c083 twice (same as bit $c083 x 2)
0000CBr 1               ;	jsr @test				;
0000CBr 1               ;	.byte $23, $34, $11, $23, $34		;
0000CBr 1               						;
0000CBr 1               
0000CBr 1  60           	rts
0000CCr 1               
0000CCr 1               @test:
0000CCr 1  EE 7B D1         inc D1
0000CFr 1  EE 1F FE         inc FE
0000D2r 1               	;; pull address off of stack: it points just below check data for this test.
0000D2r 1  68           	pla
0000D3r 1  85 3F        	sta checkdata
0000D5r 1  AA           	tax
0000D6r 1  68           	pla
0000D7r 1  85 40        	sta checkdata+1
0000D9r 1  48           	pha
0000DAr 1  8A           	txa
0000DBr 1  18           	clc
0000DCr 1  69 05        	adc #5
0000DEr 1  48           	pha
0000DFr 1  A0 00        	ldy #0
0000E1r 1               
0000E1r 1  AE 7B D1 C8      verify D1
0000E5r 1  B1 3F CD 7B  
0000E9r 1  D1 D0 3A     
0000ECr 1  AE 1F FE C8      verify FE
0000F0r 1  B1 3F CD 1F  
0000F4r 1  FE D0 2F     
0000F7r 1  AD 88 C0         lda $c088 ; $D17B in bank 1
0000FAr 1  AE 7B D1 C8      verify D1
0000FEr 1  B1 3F CD 7B  
000102r 1  D1 D0 21     
000105r 1  AD 80 C0         lda $c080 ; $D17B in bank 2
000108r 1  AE 7B D1 C8      verify D1
00010Cr 1  B1 3F CD 7B  
000110r 1  D1 D0 13     
000113r 1  AE 1F FE C8      verify FE
000117r 1  B1 3F CD 1F  
00011Br 1  FE D0 08     
00011Er 1  E6 3D            inc TEST_COUNT
000120r 1  20 rr rr         jsr @reset
000123r 1  60               rts
000124r 1               
000124r 1               @success:
000124r 1  18               clc
000125r 1  60               rts
000126r 1               
000126r 1               @fail:
000126r 1  00               brk
000127r 1               
000127r 1               @reset:
000127r 1               	;; Initialize to known state:
000127r 1               	;; - $11 in $D17B bank 1 (ROM: $53)
000127r 1               	;; - $22 in $D17B bank 2 (ROM: $53)
000127r 1               	;; - $33 in $FE1F        (ROM: $60)
000127r 1  AD 8B C0     	lda $C08B		; Read and write bank 1
00012Ar 1  AD 8B C0     	lda $C08B
00012Dr 1  A9 11        	lda #$11
00012Fr 1  8D 7B D1     	sta D1
000132r 1  A9 33        	lda #$33
000134r 1  8D 1F FE     	sta FE
000137r 1  AD 83 C0     	lda $C083		; Read and write bank 2
00013Ar 1  AD 83 C0     	lda $C083
00013Dr 1  A9 22        	lda #$22
00013Fr 1  8D 7B D1     	sta D1
000142r 1  AD 80 C0     	lda $C080
000145r 1  AD 7B D1     	lda D1
000148r 1  60           	rts
000148r 1               
